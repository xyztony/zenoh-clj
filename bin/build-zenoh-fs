#!/usr/bin/env bash
set -euo pipefail

OS="$(uname -s)"
ARCH="$(uname -m)"

if [[ "${OS}" == "Darwin" ]]; then
  TARGET_TRIPLE="aarch64-apple-darwin"
  LIB_EXT="dylib"
elif [[ "${OS}" == "Linux" ]]; then
  TARGET_TRIPLE="aarch64-unknown-linux-gnu"
  LIB_EXT="so"
else
  echo "Unsupported OS: ${OS}. Only macOS and Linux are supported."; exit 1
fi

if [[ "${ARCH}" != "arm64" && "${ARCH}" != "aarch64" ]]; then
  echo "This installer targets arm64/aarch64. Detected: ${ARCH}"; exit 1
fi

ZENOH_BIN_DIR="${HOME}/.cargo/bin"
ZENOH_LIB_DIR="${HOME}/.zenoh/lib"

if ! command -v cargo >/dev/null 2>&1; then
  echo "Error: cargo not found."; exit 1
fi

mkdir -p "${ZENOH_BIN_DIR}" "${ZENOH_LIB_DIR}"

BUILD_DIR="$(mktemp -d -t zenoh-build-XXXXX)"
cleanup() { rm -rf "${BUILD_DIR}"; }
trap cleanup EXIT

export CARGO_PROFILE_RELEASE_LTO=false
export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=16

git clone --depth 1 https://github.com/eclipse-zenoh/zenoh.git "${BUILD_DIR}/zenoh"
cd "${BUILD_DIR}/zenoh"
cargo build --release --all-targets

git clone --depth 1 https://github.com/eclipse-zenoh/zenoh-backend-filesystem.git "${BUILD_DIR}/zenoh-backend-filesystem"
cd "${BUILD_DIR}/zenoh-backend-filesystem"
cargo build --release

cp -f "${BUILD_DIR}/zenoh/target/release/zenohd" "${ZENOH_BIN_DIR}/zenohd"
chmod +x "${ZENOH_BIN_DIR}/zenohd"

cp -f "${BUILD_DIR}/zenoh/target/release/libzenoh_plugin_storage_manager.${LIB_EXT}" "${ZENOH_LIB_DIR}/"
cp -f "${BUILD_DIR}/zenoh/target/release/libzenoh_plugin_rest.${LIB_EXT}" "${ZENOH_LIB_DIR}/"
cp -f "${BUILD_DIR}/zenoh-backend-filesystem/target/release/libzenoh_backend_fs.${LIB_EXT}" "${ZENOH_LIB_DIR}/"
